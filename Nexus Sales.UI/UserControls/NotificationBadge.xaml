<UserControl x:Class="NexusSales.UI.UserControls.NotificationBadge"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:NexusSales.UI.UserControls"
             xmlns:Icon="http://metro.mahapps.com/winfx/xaml/iconpacks"
             xmlns:converters="clr-namespace:NexusSales.UI.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="32" d:DesignWidth="32">
    <UserControl.Resources>
        <converters:GreaterThanZeroToVisibilityConverter x:Key="GreaterThanZeroToVisibilityConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </UserControl.Resources>
    <Grid>
        <Button x:Name="NotificationButton" Click="NotificationButton_Click" Style="{StaticResource HeaderButtons}">
            <Button.LayoutTransform>
                <ScaleTransform x:Name="BellScale" />
            </Button.LayoutTransform>
            <Grid>
                <Grid x:Name="BellRoot" RenderTransformOrigin="0.5,0">
                    <Grid.RenderTransform>
                        <TransformGroup>
                            <ScaleTransform x:Name="BellIconScale" ScaleX="1" ScaleY="1"/>
                            <RotateTransform x:Name="BellRotate" Angle="0"/>
                        </TransformGroup>
                    </Grid.RenderTransform>
                    <!-- Notification Bell Icon -->
                    <Icon:PackIconMaterial Kind="Bell"
                                           Width="18" Height="18"
                                           VerticalAlignment="Center"
                                           HorizontalAlignment="Center"
                                           Visibility="Visible"/>
                    <!-- Notification Badge (keep only this one) -->
                    <Border x:Name="Badge"
                            Background="Red"
                            CornerRadius="10"
                            Width="16" Height="16"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Top"
                            Margin="0,-5,5,0"
                            Visibility="{Binding UnreadCount, Converter={StaticResource GreaterThanZeroToVisibilityConverter}}">
                        <TextBlock Text="{Binding UnreadCount}"
                                   Foreground="White"
                                   FontSize="9"
                                   FontWeight="Bold"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                    </Border>
                </Grid>
            </Grid>
            <Button.Effect>
                <DropShadowEffect x:Name="BellGlow" BlurRadius="10" ShadowDepth="0" Color="#6600AEEF" Opacity="0.4"/>
            </Button.Effect>
            <Button.Triggers>
                <EventTrigger RoutedEvent="Button.MouseEnter">
                    <BeginStoryboard>
                        <Storyboard>
                            <!-- Ringing bell swing: -32, +32, -24, +24, -12, +12, 0 -->
                            <DoubleAnimationUsingKeyFrames Storyboard.TargetName="BellRotate"
                                                           Storyboard.TargetProperty="Angle">
                                <EasingDoubleKeyFrame KeyTime="0:0:0.00" Value="0"/>
                                <EasingDoubleKeyFrame KeyTime="0:0:0.07" Value="22"/>
                                <EasingDoubleKeyFrame KeyTime="0:0:0.14" Value="-22"/>
                                <EasingDoubleKeyFrame KeyTime="0:0:0.21" Value="14"/>
                                <EasingDoubleKeyFrame KeyTime="0:0:0.28" Value="-14"/>
                                <EasingDoubleKeyFrame KeyTime="0:0:0.35" Value="12"/>
                                <EasingDoubleKeyFrame KeyTime="0:0:0.42" Value="-12"/>
                                <EasingDoubleKeyFrame KeyTime="0:0:0.50" Value="0"/>
                            </DoubleAnimationUsingKeyFrames>
                            <!-- Optional: pop and glow -->
                            <DoubleAnimation Storyboard.TargetName="BellScale"
                                             Storyboard.TargetProperty="ScaleX"
                                             To="1.0" Duration="0:0:0.12" AutoReverse="True"/>
                            <DoubleAnimation Storyboard.TargetName="BellScale"
                                             Storyboard.TargetProperty="ScaleY"
                                             To="1.0" Duration="0:0:0.12" AutoReverse="True"/>
                            <DoubleAnimation Storyboard.TargetName="BellGlow"
                                             Storyboard.TargetProperty="Opacity"
                                             To="2.7" Duration="0:0:0.15"/>
                            <DoubleAnimation Storyboard.TargetName="BellGlow"
                                             Storyboard.TargetProperty="BlurRadius"
                                             To="18" Duration="0:0:0.15"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
                <EventTrigger RoutedEvent="Button.MouseLeave">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetName="BellScale"
                                             Storyboard.TargetProperty="ScaleX"
                                             To="1.0" Duration="0:0:0.18"/>
                            <DoubleAnimation Storyboard.TargetName="BellScale"
                                             Storyboard.TargetProperty="ScaleY"
                                             To="1.0" Duration="0:0:0.18"/>
                            <DoubleAnimation Storyboard.TargetName="BellRotate"
                                             Storyboard.TargetProperty="Angle"
                                             To="0" Duration="0:0:0.18"/>
                            <DoubleAnimation Storyboard.TargetName="BellGlow"
                                             Storyboard.TargetProperty="Opacity"
                                             To="0.3" Duration="0:0:0.18"/>
                            <DoubleAnimation Storyboard.TargetName="BellGlow"
                                             Storyboard.TargetProperty="BlurRadius"
                                             To="8" Duration="0:0:0.18"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Button.Triggers>
        </Button>

        <Popup x:Name="NotificationsPopup" 
               PlacementTarget="{Binding ElementName=NotificationButton}" 
               Placement="Bottom"
               StaysOpen="False"
               AllowsTransparency="True"
               Width="350"
               Height="350"
               Opened="NotificationsPopup_Opened">
            <Grid>
                <local:NotificationsPanel ViewModel="{Binding}" Margin="5"/>
            </Grid>
        </Popup>
    </Grid>
</UserControl>